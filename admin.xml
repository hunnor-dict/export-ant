<?xml version="1.0" encoding="UTF-8"?>
<project name="hunnor-admin-ant" default="dump">

	<description>Export the dictionary database to XML. Back up the dictionary database.</description>

	<property name="build.dir" location="build"/>

	<property environment="env"/>

	<property name="env.HUNNOR_ANT_DEPLOY_DIR" location="/opt/hunnor-dict/Dropbox"/>
	<property name="env.HUNNOR_ANT_DEPLOY_BACKUP_DIR" location="${env.HUNNOR_ANT_DEPLOY_DIR}/Backup"/>
	<property name="env.HUNNOR_ANT_DEPLOY_PUB_DIR" location="${env.HUNNOR_ANT_DEPLOY_DIR}/Public"/>
	<property name="env.HUNNOR_ANT_DEPLOY_PUB_DB_DIR" location="${env.HUNNOR_ANT_DEPLOY_PUB_DIR}/Databases"/>
	<property name="env.HUNNOR_ANT_PROJECT_DIR" location="/opt/hunnor-dict"/>

	<!-- Export -->

	<target name="build.dir">
		<mkdir dir="${build.dir}"/>
	</target>

	<target name="dump.hu" depends="build.dir">
		<exec dir="${env.HUNNOR_ANT_PROJECT_DIR}/admin-rails" executable="bundle">
			<arg line="exec rake hn:export['hu','${build.dir}']"/>
			<env key="DB_MYSQL_PASS" value="${env.HUNNOR_ANT_MYSQL_PASSWORD}"/>
		</exec>
	</target>

	<target name="dump.nb" depends="build.dir">
		<exec dir="${env.HUNNOR_ANT_PROJECT_DIR}/admin-rails" executable="bundle">
			<arg line="exec rake hn:export['nb','${build.dir}']"/>
			<env key="DB_MYSQL_PASS" value="${env.HUNNOR_ANT_MYSQL_PASSWORD}"/>
		</exec>
	</target>

	<target name="dump" depends="dump.hu,dump.nb"/>

	<!-- Backup -->

	<target name="week.of.year">
		<tstamp>
			<format property="week" pattern="w"/>
		</tstamp>
	</target>

	<target name="backup" depends="week.of.year">
		<exec executable="mysqldump" output="hunnor.MySQL.${week}.sql">
			<arg line="-u hunnor hunnor hn_hun_segment hn_hun_tr_nob_tmp hn_nob_segment hn_nob_tr_hun_tmp"/>
		</exec>
		<gzip src="hunnor.MySQL.${week}.sql" destfile="hunnor.MySQL.${week}.sql.gz"/>
		<delete file="hunnor.MySQL.${week}.sql"/>
		<copy file="hunnor.MySQL.${week}.sql.gz" tofile="${env.HUNNOR_ANT_DEPLOY_PUB_DB_DIR}/HunNor-MySQL.sql.gz"/>
		<move file="hunnor.MySQL.${week}.sql.gz" todir="${env.HUNNOR_ANT_DEPLOY_BACKUP_DIR}"/>
	</target>

</project>
